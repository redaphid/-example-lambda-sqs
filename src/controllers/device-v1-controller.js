// Generated by CoffeeScript 2.4.1
var DeviceV1Controller, JobToHttp, _, debug;

_ = require('lodash');

JobToHttp = require('../helpers/job-to-http');

debug = require('debug')('meshblu-core-protocol-adapter-http:get-device-controller');

DeviceV1Controller = class DeviceV1Controller {
  constructor({jobManager, jobToHttp}) {
    this.claimdevice = this.claimdevice.bind(this);
    this.get = this.get.bind(this);
    this.getPublicKey = this.getPublicKey.bind(this);
    this.jobManager = jobManager;
    this.jobToHttp = jobToHttp;
  }

  claimdevice(req, res) {
    var job;
    job = this.jobToHttp.httpToJob({
      jobType: 'UpdateDevice',
      request: req,
      toUuid: req.params.uuid
    });
    job.data = {
      $addToSet: {
        discoverWhitelist: job.metadata.fromUuid,
        configureWhitelist: job.metadata.fromUuid
      },
      $set: {
        owner: job.metadata.fromUuid
      }
    };
    debug('dispatching request', job);
    return this.jobManager.do(job, (error, jobResponse) => {
      if (error != null) {
        return res.sendError(error);
      }
      return this.jobToHttp.sendJobResponse({res, jobResponse});
    });
  }

  get(req, res) {
    var job;
    job = this.jobToHttp.httpToJob({
      jobType: 'GetDevice',
      request: req,
      toUuid: req.params.uuid
    });
    debug('dispatching request', job);
    return this.jobManager.do(job, (error, jobResponse) => {
      var data, jsonError, ref, ref1;
      if ((error == null) && ((ref = jobResponse.metadata) != null ? ref.code : void 0) === 403) {
        error = {
          code: 404,
          message: 'Devices not found'
        };
      }
      if (error != null) {
        if (error.code === 403) { // backwards compatibility with meshblu
          error.code = 404;
          error.message = 'Devices not found';
        }
        jsonError = {
          code: error.code,
          message: error.message
        };
        return res.status((ref1 = error.code) != null ? ref1 : 500).send(jsonError);
      }
      // mutate to old meshblu devices array
      data = JSON.parse(jobResponse.rawData);
      jobResponse.rawData = JSON.stringify({
        devices: [data]
      });
      return this.jobToHttp.sendJobResponse({res, jobResponse});
    });
  }

  getPublicKey(req, res) {
    var job;
    job = this.jobToHttp.httpToJob({
      jobType: 'GetDevicePublicKey',
      request: req,
      toUuid: req.params.uuid
    });
    debug('dispatching request', job);
    return this.jobManager.do(job, (error, jobResponse) => {
      if (error != null) {
        return res.sendError(error);
      }
      return this.jobToHttp.sendJobResponse({jobResponse, res});
    });
  }

};

module.exports = DeviceV1Controller;
